---
title: "Missing data in health surveys"
author: "Juan Li and the recodeflow contributors"
date: 2025-11-02
format:
  html:
    toc: true
    html-math-method: katex
    css: styles.css
editor: visual
---

```{r}
#| label: setup
#| include: false
# Load package - works in both local dev and pkgdown build
if (file.exists("../DESCRIPTION")) {
  devtools::load_all("../", quiet = TRUE)
} else {
  library(MockData)
}
```

::: callout-note
## About this vignette

This outline document is a work-in-progress planning document for the missing data tutorial. It is not yet a complete tutorial.
:::

# OUTLINE FOR MISSING DATA TUTORIAL

## Purpose
Explain how to generate realistic missing data in mock health survey datasets and why proper missing data handling matters for survey analysis.

## Target audience
- Survey analysts learning to work with CCHS/CHMS data
- Researchers developing analysis pipelines
- Students learning health survey methodology

---

## Section 1: Understanding missing data types in health surveys

### 1.1 Why missing data codes matter

**Content**:

- Missing data is NOT just "NA" in health surveys
- Different types of missingness have different statistical implications
- Improper handling leads to biased estimates

**Example**: Show prevalence calculation done wrong vs. right

### 1.2 The three types of missing data codes

**Content**:

- **Valid skip (996, NA::a)**: Not asked due to skip logic
  - Example: "Number of cigarettes per day" skipped if non-smoker
  - Statistical treatment: Exclude from denominator

- **Don't know/Refusal/Not stated (997, 998, 999, NA::b)**: Asked but no valid response
  - 997: Don't know
  - 998: Refusal
  - 999: Not stated
  - Statistical treatment: Include in denominator for response rate, exclude from numerator

- **Not applicable (NA::a)**: Question doesn't apply to respondent
  - Statistical treatment: Usually same as valid skip

**Visual**: Decision tree for classifying missing codes

### 1.3 Real-world example from CCHS

**Content**:

- Use actual CCHS variable (like alcohol consumption)
- Show variable_details from chmsflow/cchsflow
- Demonstrate how missing codes appear in metadata
- Calculate response rate vs. prevalence

---

## Section 2: Generating missing data with MockData

### 2.1 Method 1: Explicit proportions (recommended)

**Content**:

- Use `proportions` parameter to specify ALL categories including missing codes
- Gives full control over distribution
- Best for teaching/demonstrating proper analysis

**Code example**:
```r
create_cat_var(
  var_raw = "ALC_11",
  proportions = list(
    "1" = 0.30,   # Yes
    "2" = 0.60,   # No
    "6" = 0.03,   # Valid skip
    "7" = 0.02,   # Don't know
    "8" = 0.03,   # Refusal
    "9" = 0.02    # Not stated
  )
)
```

**When to use**: When you need precise control, teaching examples, realistic mock data

### 2.2 Method 2: The prop_NA shortcut

**Content**:

- Use `prop_NA` parameter for quick missing data generation
- MockData uniformly distributes across all NA codes in metadata
- Less control but faster for testing
- Works for both categorical and continuous variables

**Code example - categorical**:
```r
create_cat_var(
  var_raw = "ALC_11",
  prop_NA = 0.10  # 10% missing, distributed across 6,7,8,9
)
```

**Code example - continuous**:
```r
create_con_var(
  var_raw = "AGE_01",
  prop_NA = 0.05  # 5% missing, distributed across 996,997,998,999
)
```

**Show output**: Demonstrate how to check missingness with `table()` or `sum()`

**When to use**: Quick testing, when exact missing distribution doesn't matter

**Note**: This section covers material moved from getting-started.qmd Step 4

### 2.3 Method 3: Metadata-driven proportions

**Content**:

- If variable_details has `proportion` column, MockData uses it automatically
- Good for generating data matching real survey distributions
- Requires properly formatted metadata

**Code example**:
```r
# Assuming variable_details has proportion column
create_cat_var(
  var_raw = "ALC_11"
  # No proportions parameter needed
)
```

**When to use**: Matching real survey distributions, production mock data

---

## Section 3: Analyzing data with missing codes

### 3.1 Calculating response rates

**Content**:

- Response rate = (Valid responses) / (Valid responses + DK/RF/NS)
- Exclude valid skip (6) from denominator
- Include 7,8,9 in denominator

**Code example**:
```r
response_rate <- sum(data$var %in% c("1", "2")) /
                 sum(data$var %in% c("1", "2", "7", "8", "9"))
```

### 3.2 Calculating prevalence correctly

**Content**:

- Prevalence = (Outcome present) / (All asked excluding valid skip)
- Numerator: Only valid "yes" responses
- Denominator: Valid responses + DK/RF/NS (exclude valid skip)

**Code example**:
```r
# Wrong - ignores missing responses
wrong_prev <- sum(data$smoker == "1") / sum(data$smoker %in% c("1", "2"))

# Correct - includes DK/RF/NS in denominator
correct_prev <- sum(data$smoker == "1") /
                sum(data$smoker %in% c("1", "2", "7", "8", "9"))
```

**Example**: Show how estimates differ with realistic data

### 3.3 Handling valid skip in analysis

**Content**:

- Why valid skip (6) should be excluded
- Example: Skip patterns in surveys (e.g., children don't get pregnancy questions)
- Statistical justification

**Code example**:
```r
# Filter out valid skip before analysis
analysis_data <- data %>%
  filter(!(var %in% c("6", "996")))
```

---

## Section 4: Common mistakes and how to avoid them

### 4.1 Mistake: Treating all missing as the same

**Problem**: Using `is.na()` or removing all non-valid responses
**Impact**: Biased estimates, inflated/deflated prevalence
**Solution**: Explicitly handle each missing type

### 4.2 Mistake: Including valid skip in denominator

**Problem**: Including 6/996 when calculating prevalence
**Impact**: Underestimates prevalence, wrong interpretation
**Solution**: Filter valid skip before analysis

### 4.3 Mistake: Excluding DK/RF/NS from response rate

**Problem**: Ignoring 7,8,9 when reporting response quality
**Impact**: Overestimates data quality, misleading response rates
**Solution**: Include in denominator for response rate calculations

---

## Section 5: Practical examples

### 5.1 Example: Smoking prevalence with realistic missing data

**Content**:

- Generate 10,000 observations with realistic proportions
- Calculate crude prevalence
- Calculate age-standardized prevalence
- Report response rate
- Show proper table formatting for publication

### 5.2 Example: Alcohol consumption with skip logic

**Content**:

- Generate data with valid skip for non-drinkers
- Analyze drinking frequency among drinkers only
- Handle conditional questions properly

### 5.3 Example: Sensitivity analysis with missing data

**Content**:

- Best case scenario (all DK/RF/NS = negative)
- Worst case scenario (all DK/RF/NS = positive)
- Show impact on confidence intervals

---

## Section 6: Advanced topics

### 6.1 Missing data patterns in longitudinal data

**Content**:

- How missing codes evolve across survey cycles
- Handling panel attrition
- Multiple imputation considerations

### 6.2 Weighting and missing data

**Content**:

- How survey weights interact with missing data
- When to apply weights in mock data
- Non-response adjustments

### 6.3 Custom missing code schemes

**Content**:

- Creating project-specific missing codes
- Documenting custom schemes in metadata
- Ensuring compatibility with MockData

---

## Summary

Key takeaways:
1. Missing data has structure - not all missing is the same
2. Valid skip (6/996) â‰  Don't know/Refusal (7,8,9)
3. Use explicit `proportions` parameter for teaching examples
4. Always check denominator in prevalence calculations
5. Report response rates alongside prevalence estimates

## References

- Statistics Canada CCHS User Guide (missing data section)
- CHMS Data User Guide (response rates)
- Groves et al. (2009) Survey Methodology (missing data chapter)

## Next steps

- [Getting started with MockData](getting-started.html)
- [Advanced topics](advanced-topics.html)
- [CCHS example workflow](cchs-example.html)
